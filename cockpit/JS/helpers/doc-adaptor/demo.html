<html>
  <head>
    <title>WfAdaptor Demo</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <script type="text/javascript" src="../jquery.min.js"></script>
    <script type="text/javascript" src="../jquery.svgdom.js"></script>
    <script type="text/javascript" src="../underscore.min.js"></script>
    <script type="text/javascript" src="../../wfadaptor.js"></script>
    <script type="text/javascript" src="../../graph.js"></script>
    <link rel="stylesheet" href="../../wfadaptor.css" type="text/css"/>
    <script type="text/javascript">
      var adaptor = null;
      var parser = DOMParser();
      function click_update_graph() {
        console.log("Demo: Graph Update");
        var then = new Date();
        adaptor.set_description($('#description').val());
        $('#t_new').text((new Date()).getTime() - then.getTime() + 'ms'); 
        then = new Date();
        var xml = parser.parseFromString($('#description').val(),"text/xml");
        var g = new WFGraph(xml,xml.documentElement, $("#canvas").get(0));
        var width = g.generateGraph();
        $('#t_old').text((new Date()).getTime() - then.getTime() + 'ms'); 
      }
      function update_event(element_id, operation) {
        console.log("Demo: update notification [ID: "+element_id+ ", OP: "+operation+"]");
      }
    </script>
  </head>
  <body>
    <table style="background: ThreeDShadow; width: 100%; height: 100%;" border="0">
      <tr>
        <td style="text-align:center; vertical-align:middle"><button type="button" onclick="click_update_graph();">Update Graph &gt;&gt;&gt; </button></td>
        <td style="text-align:center; vertical-align:middle"><b><font size="+2">Workflow Graph</font></b></td>
      </tr>
      <tr height="95%">
        <td width="40%" style="vertical-align:middle; text-align:center"><!-- {{{ -->
          <textarea style="width:98%;height:98%" id="description">
  <description xmlns="http://cpee.org/ns/description/1.0"><!--{{{-->
    <call id="a1" endpoint="timeout">
      <parameters><!--{{{-->

        <method>post</method>
        <parameters>
          <timeout>2</timeout>
        </parameters>
      </parameters><!--}}}-->
      <manipulate output="result">  data.x += "a1,"</manipulate>  
    </call>  

    <parallel>
      <parallel_branch>
        <call id="a20" endpoint="timeout">
          <parameters><!--{{{-->
            <method>post</method>
            <parameters>
              <timeout>4</timeout>
            </parameters>
          </parameters><!--}}}-->
          <manipulate output="result">  data.x += "a2,"</manipulate>  
        </call>  
      </parallel_branch>
      <parallel_branch>
        <call id="a22" endpoint="timeout">
          <parameters><!--{{{-->
            <method>post</method>
            <parameters>
              <timeout>4</timeout>
            </parameters>
          </parameters><!--}}}-->
          <manipulate output="result">  data.x += "a2,"</manipulate>  
        </call>  
      </parallel_branch>
    </parallel>
<critical>
    <call id="a3" endpoint="timeout">
      <parameters><!--{{{-->
        <method>post</method>
        <parameters>
          <timeout>4</timeout>
        </parameters>
      </parameters><!--}}}-->
      <manipulate output="result">  data.x += "a3,"</manipulate>  
    </call>
</critical>  
    <call id="a1" endpoint="timeout">
      <parameters><!--{{{-->

        <method>post</method>
        <parameters>
          <timeout>2</timeout>
        </parameters>
      </parameters><!--}}}-->
      <manipulate output="result">  data.x += "a1,"</manipulate>  
    </call>  

    <choose>
      <alternative>
<loop>
        <call id="a20" endpoint="timeout">
          <parameters><!--{{{-->
            <method>post</method>
            <parameters>
              <timeout>4</timeout>
            </parameters>
          </parameters><!--}}}-->
          <manipulate output="result">  data.x += "a2,"</manipulate>  
        </call>  
<loop>
        <call id="a20" endpoint="timeout">
          <parameters><!--{{{-->
            <method>post</method>
            <parameters>
              <timeout>4</timeout>
            </parameters>
          </parameters><!--}}}-->
          <manipulate output="result">  data.x += "a2,"</manipulate>  
        </call>  
</loop>
</loop>
      </alternative>
      <alternative>
        <call id="a22" endpoint="timeout">
          <parameters><!--{{{-->
            <method>post</method>
            <parameters>
              <timeout>4</timeout>
            </parameters>
          </parameters><!--}}}-->
          <manipulate output="result">  data.x += "a2,"</manipulate>  
        </call>  
      </alternative>
    </choose>

    <call id="a3" endpoint="timeout">
      <parameters><!--{{{-->
        <method>post</method>
        <parameters>
          <timeout>4</timeout>
        </parameters>
      </parameters><!--}}}-->
      <manipulate output="result">  data.x += "a3,"</manipulate>  
    </call>  



  </description><!--}}}-->
          </textarea>
        </td><!-- }}} --> 
        <td style="vertical-align: top"><!-- {{{ -->
          <h3>New Graph Version -> Built-Time:<span id="t_new">00</span></h3>
          <svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="600" width="300" xmlns:xlink="http://www.w3.org/1999/xlink">
            <defs><!-- {{{ --> 
              <symbol id="call" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normal" transform='translate(15,21)'>c</text>
              </symbol><!-- }}} -->
              <symbol id="manipulate" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normal" transform='translate(15,21)'>m</text>
              </symbol><!-- }}} -->
              <symbol id="callinject" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normal" transform='translate(15,21)'>c</text>
                <circle cx="28" cy="27" r="9" class="stand"></circle>
                <text class="small" transform='translate(28,32)'>i</text>
              </symbol><!-- }}} -->
              <symbol id="callmanipulate" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normal" transform='translate(15,21)'>c</text>
                <circle cx="28" cy="28" r="9" class="stand"></circle>
                <text class="small" transform='translate(28,32)'>m</text>
              </symbol><!-- }}} -->
              <symbol id="choose" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normal" transform='translate(15,21)'>σ</text>
              </symbol><!-- }}} -->
              <symbol id="alternative" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="standwithout"></circle>
                <text class="normal" transform='translate(15,20)'>{..}</text>
              </symbol><!-- }}} -->
              <symbol id="otherwise" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="standwithout"></circle>
                <text class="normal" transform='translate(15,20)'>{⁎}</text>
              </symbol><!-- }}} -->
              <symbol id="parallel" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normal" transform='translate(15,21)'>||</text>
              </symbol><!-- }}} -->
              <symbol id="parallel_branch" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normal" transform='translate(15,21)'>|</text>
              </symbol><!-- }}} -->
              <symbol id="critical" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normal" transform='translate(16.5,21.5)'>⚠</text>
              </symbol><!-- }}} -->
              <symbol id="loop" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normallarge" transform='translate(15,23)'>↺</text>
              </symbol><!-- }}} -->
              <symbol id="end"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <circle cx="15" cy="15" r="11" class="stand"></circle>
                <text class="normal" transform='translate(15,21)'>Ω</text>
              </symbol><!-- }}} -->
              <marker id="arrow" viewBox="0 0 10 10" refX="24" refY="5" orient="auto" markerUnits="strokeWidth" markerWidth="4.5" markerHeight="4.5">
                <path d="m 2 2 l 6 3 l -6 3 z"></path>
              </marker>
            </defs><!-- }}} -->
            <g id="drawing_area">
              <g id="blocks_new"></g>
              <g id="lines_new"></g>
              <g id="symbols_new"></g>
            </g>
          </svg>
        </td><!-- }}} -->
        <td style="vertical-align: top"><!-- {{{ -->
          <h3>Old Graph Version -> Built-Time:<span id="t_old">00</span></h3>
          <svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="600" width="300" xmlns:xlink="http://www.w3.org/1999/xlink">
            <defs><!-- {{{ --> 
              <symbol id="call" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normal" transform='translate(15,21)'>c</text>
              </symbol><!-- }}} -->
              <symbol id="manipulate" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normal" transform='translate(15,21)'>m</text>
              </symbol><!-- }}} -->
              <symbol id="callinject" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normal" transform='translate(15,21)'>c</text>
                <circle cx="28" cy="27" r="9" class="stand"></circle>
                <text class="small" transform='translate(28,32)'>i</text>
              </symbol><!-- }}} -->
              <symbol id="callmanipulate" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normal" transform='translate(15,21)'>c</text>
                <circle cx="28" cy="28" r="9" class="stand"></circle>
                <text class="small" transform='translate(28,32)'>m</text>
              </symbol><!-- }}} -->
              <symbol id="choose" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normal" transform='translate(15,21)'>σ</text>
              </symbol><!-- }}} -->
              <symbol id="alternative" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="standwithout"></circle>
                <text class="normal" transform='translate(15,20)'>{..}</text>
              </symbol><!-- }}} -->
              <symbol id="otherwise" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="standwithout"></circle>
                <text class="normal" transform='translate(15,20)'>{⁎}</text>
              </symbol><!-- }}} -->
              <symbol id="parallel" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normal" transform='translate(15,21)'>||</text>
              </symbol><!-- }}} -->
              <symbol id="parallel_branch" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normal" transform='translate(15,21)'>|</text>
              </symbol><!-- }}} -->
              <symbol id="critical" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normal" transform='translate(16.5,21.5)'>⚠</text>
              </symbol><!-- }}} -->
              <symbol id="loop" class="clickable"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <text class="normallarge" transform='translate(15,23)'>↺</text>
              </symbol><!-- }}} -->
              <symbol id="end"><!-- {{{ -->
                <circle cx="15" cy="15" r="14" class="stand"></circle>
                <circle cx="15" cy="15" r="11" class="stand"></circle>
                <text class="normal" transform='translate(15,21)'>Ω</text>
              </symbol><!-- }}} -->
              <marker id="arrow" viewBox="0 0 10 10" refX="24" refY="5" orient="auto" markerUnits="strokeWidth" markerWidth="4.5" markerHeight="4.5">
                <path d="m 2 2 l 6 3 l -6 3 z"></path>
              </marker>
            </defs><!-- }}} -->
            <g id="canvas">
              <g id="blocks"></g>
              <g id="lines"></g>
              <g id="symbols"></g>
            </g>
          </svg>
        </td><!-- }}} -->
      </tr>
    </table>
    <script type="text/javascript">
      var then = new Date();
      adaptor = new WfAdaptor($('#description').val(), $('#drawing_area'));
      $('#t_new').text((new Date()).getTime() - then.getTime() + 'ms'); 
      adaptor.notify = update_event;
      adaptor.notify('none','test call from demo');
      then = new Date();
      var xml = parser.parseFromString($('#description').val(),"text/xml");
      var g = new WFGraph(xml,xml.documentElement, $("#canvas").get(0));
      var width = g.generateGraph();
      $('#t_old').text((new Date()).getTime() - then.getTime() + 'ms'); 
      //console.log(adaptor.get_description());
    </script>
  </body>
</html>
