<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>

    <title>WEE - Detail</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="static/index.css" type="text/css"/>
    <script src="static/jquery-1.3.2.min.js" type="text/javascript"></script>
<!--    <script src="static/script.js" type="text/javascript"></script>-->
  </head>
  <body>
    <h1>WEE - WICK</h1>
    
    <input type="button" value="Start" id="btn_startstop" onclick="togglestartstop()"/>

    <form id="frm_userinterface" name="frm_userinterface">
            <table>
                <tr>
                    <td valign="top">Monitor:</td>
                    <td>undefined</td>
                </tr>
                <tr>
                    <td valign="top">Repair: </td>
                    <td>undefined</td>
                </tr>
                <tr>
                    <td valign="top">State: </td>
                    <td><div id="div_state">undefined</div></td>
                </tr>
                <tr>
                    <td valign="top">Context:</td>
                    <td>
                        <a href="javascript:unhide('div_context');">Show/Hide</a>
                        <div id="div_context" class="hidden">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td valign="top">Endpoints:</td>
                    <td>
                        <a href="javascript:unhide('div_endpoints');">Show/Hide</a>
                        <div id="div_endpoints" class="hidden">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td valign="top">Description:</td>
                    <td>
                        <a href="javascript:unhide('div_description');">Show/Hide</a>
                        <div id="div_description" class="hidden">
                            <textarea id ="txt_description" cols="60" rows="10"></textarea>
                        </div>
                    </td>
                </tr>
            </table>
            <button id="btn_apply" type="button" onclick="javascript:apply()">Apply to current instance</button>
    </form>
    <h5>WorkflowExecutionEngine - Workflow Information CocKpit</h5>
    <p>activity :a1, :call, hotel, @x, @y</p>
  </body>




    <div class="invisible" id="add_context">
        <div>
            <button type="button" onclick="$(this).parent().remove()" title="Contextvariable entfernen">
                <img class='small' src='static/Images/list-remove.png' width='16' height='16' alt="Contextvariable entfernen" title="Contextvariable entfernen"/>
            </button>
            <input value="name" type="text" id="context_variable_name"/>
            <input value="value" type="text" id="context_variable_value" />
        </div>
    </div>

    <div class="invisible" id="add_endpoint">
        <div>
            <button type="button" onclick="$(this).parent().remove()" title="Endpoint entfernen">
                <img class='small' src='static/Images/list-remove.png' width='16' height='16' alt="Endpoint entfernen" title="Endpoint entfernen"/>
            </button>
            <input value="name" type="text" id="endpoint_name"/>
            <input value="url" type="text" id="endpoint_value"/>
        </div>
    </div>
    
    <div class="invisible" id="context_add_button">
        <button id="btn_addcontext" type="button" onclick="$('#div_context').append(generateContext('name', 'value'))" title="Contextvariable hinzufügen">
            <img class='small' src='static/Images/list-add.png' width='16' height='16' alt="Contextvariable hinzufügen" title="Contextvariable hinzufügen"/>
        </button>
    </div>
    <div class="invisible" id="endpoint_add_button">
        <button id="btn_addendpoint" type="button" onclick="$('#div_endpoints').append(generateEndpoint('name', 'url'))" title="Endpoint hinzufügen">
            <img class='small' src='static/Images/list-add.png' width='16' height='16' alt="Endpoint hinzufügen" title="Endpoint hinzufügen"/>
        </button>
    </div>


<script type='text/javascript'>
    function unhide(divID) {
      var item = document.getElementById(divID);
      if (item) {
        item.className=(item.className=='hidden')?'unhidden':'hidden';
      }
    }


    var wee_url = "";

    function makeRequest(method, url, success, failure) {
        var req = new XMLHttpRequest();  
        req.open(method, url, true);  
        req.onreadystatechange = function (e) {  
            if (req.readyState === 4) {  
                if(req.status === 200) {
                    success(req.responseText);
                } else {  
                    failure("method "+method+" to "+url+" failed");
                }
                method
            }  
        };  
        req.send(null);
    }
    function report_failure(text) {
        console.log("ERROR: "+text);
    }

    function loadInstance() {
        console.log("Loading instance data");
        // Getting the state of execution
        makeRequest(
            "GET", (wee_url+location.pathname+"/state/"),
            function(instance_state){
                $("#div_state").text(instance_state);
                if(instance_state == "finished") {
                    running = false;
                    $("#btn_startstop").val("Start");
                    toggleControls(true);
                }
            },report_failure
        );
        // Getting the workflow description
        makeRequest(
            "GET", (wee_url+location.pathname+"/properties/description/"),
            function(instance_description){
                $("#txt_description").val(instance_description);
            },report_failure
        );
        // Getting the Context
        makeRequest(
            "GET", (wee_url+location.pathname+"/properties/context/"),
            function(xml){
                var context_text = "";
                var count = 0;
                $(xml).find("a").each(function() {
                  var a = $(this);
                  var context_id = a.text();
                  makeRequest(
                    "GET", (wee_url+location.pathname+"/properties/context/"+context_id),
                    function(context_value){
                      context_text += generateContext(context_id, context_value);
                      count++;
                      if(count == $(xml).find("a").length) replaceContext(context_text);
                    },report_failure
                  );
                })
            }, report_failure
        );

        // Getting the Endpoints
        makeRequest(
            "GET", (wee_url+location.pathname+"/properties/endpoints/"),
            function(xml){
                var endpoint_text = "";
                var count = 0;
                $(xml).find("a").each(function() {
                  var a = $(this);
                  var endpoint_id = a.text();
                  makeRequest(
                    "GET", (wee_url+location.pathname+"/properties/endpoints/"+endpoint_id),
                    function(endpoint_value){
                      endpoint_text += generateEndpoint(endpoint_id, endpoint_value);
                      count++;
                      if(count == $(xml).find("a").length) replaceEndpoints(endpoint_text)
                    },report_failure
                  );
                })
            }, report_failure
        );
    }
    var context_i = 0;
    function replaceContext(text) {
        $("#div_context").html($("#context_add_button").html()+text);
    }
    function generateContext(name, value) {
        var text = $("#add_context").html();
        text = text.replace(/context_variable_name/,"context_variable_name_" + context_i);
        text = text.replace(/context_variable_value/,"context_variable_value_" + context_i);
        text = text.replace(/value=\"name\"/, "value=\""+name+"\"");
        text = text.replace(/value=\"value\"/, "value=\""+value+"\"");
        context_i += 1;
        return text;
    }
    var endpoint_i = 0;
    function replaceEndpoints(text) {
        $("#div_endpoints").html($("#endpoint_add_button").html()+text);
    }
    function generateEndpoint(name, url) {
        var text = $("#add_endpoint").html();
        text = text.replace(/endpoint_name/,"endpoint_name_" + endpoint_i);
        text = text.replace(/endpoint_value/,"endpoint_value_" + endpoint_i);
        text = text.replace(/value=\"name\"/, "value=\""+name+"\"");
        text = text.replace(/value=\"url\"/, "value=\""+url+"\"");
        endpoint_i += 1;
        return text;
    }


    function setContextVariable_serverside(context_id, context_value) {
        makeRequest(
            "POST", (wee_url+location.pathname+"/properties/context?id="+context_id+"&value="+context_value),
            function(){
            },report_failure
        );
    }
    function setEndpoint_serverside(endpoint_id, endpoint_value) {
        makeRequest(
            "POST", (wee_url+location.pathname+"/properties/endpoints?id="+endpoint_id+"&value="+endpoint_value),
            function(){
            },report_failure
        );
    }
    function setDescription_serverside(description) {
        makeRequest(
            "PUT", (wee_url+location.pathname+"/properties/description?description="+encodeURIComponent(description)),
            function(){
            },report_failure
        );
    }




    
    function apply() {
        // apply context
        for(var i = 0; i < context_i; i++) {
            name = $("#context_variable_name_"+i).val();
            value = $("#context_variable_value_"+i).val();
            setContextVariable_serverside(name, value);
        }
        // apply endpoints
        for(var i = 0; i < endpoint_i; i++) {
            name = $("#endpoint_name_"+i).val();
            value = $("#endpoint_value_"+i).val();
            setEndpoint_serverside(name, value);
        }

        // apply description
        desc = $("#txt_description").val();
        setDescription_serverside(desc);
    }

    var running = false;
    function setPolling() {
        if(running) {
            loadInstance();
            window.setTimeout("setPolling()", 4000);
        }
    }
    function togglestartstop() {
        if(!running) {
            start();
        }
        else {
            stop();
        }

    }
    function start() {
        // deactivate controls
        // start the wee
        console.log("Starting the wee")
        makeRequest(
            "PUT", (wee_url+location.pathname+"/state?control=start"),
            function(instance_state){
                console.log("got instance state = "+instance_state);
                $("#div_state").text(instance_state);
            },report_failure
        );
        // update start/stop button
        $("#btn_startstop").val("Stop");
        running = true;
        // refresh ui constantly
        setPolling();
        toggleControls(false);
    }
    function stop() {
        // stop the wee
        console.log("Stop the wee")
        makeRequest(
            "PUT", (wee_url+location.pathname+"/state?control=stop"),
            function(instance_state){
                console.log("got instance state = "+instance_state);
                $("#div_state").text(instance_state);
            },report_failure
        );
        // update start/stop button
        $("#btn_startstop").val("Start");
        running = false;
        toggleControls(true);
    }
    function toggleControls(on) {
        if(!on) {
            $('input[type=text]').attr('disabled', 'disabled');
            $('input[type=button]').attr('disabled', 'disabled');
            $('button').attr('disabled', 'disabled');
            $('#btn_startstop').removeAttr('disabled');
        }
        else {
            $('input[type=text]').removeAttr('disabled');
            $('input[type=button]').removeAttr('disabled');
            $('button').removeAttr('disabled');
        }
    }

    console.log("Fetching wee url");
    $.ajax({
      type: "GET",
      url: "remote",
      cache: false,
      success: function(url){
        wee_url = url;
        console.log("got wee url: "+wee_url+". my path is "+location.pathname);
        loadInstance();
        console.log("checking for dummy values");
      }
    });

</script>

</html>
