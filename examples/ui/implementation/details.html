<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>

    <title>WEE - Detail</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="static/index.css" type="text/css"/>
    <script src="static/jquery-1.3.2.min.js" type="text/javascript"></script>
<!--    <script src="static/script.js" type="text/javascript"></script>-->
  </head>
  <body>
    <h1>WEE - WICK</h1>
    
    <input type="button" value="Start" id="btn_startstop" onclick="togglestartstop()"/>

    <form id="frm_userinterface" name="frm_userinterface">
            <table>
                <tr>
                    <td valign="top">Monitor:</td>
                    <td>undefined</td>
                </tr>
                <tr>
                    <td valign="top">Repair: </td>
                    <td>undefined</td>
                </tr>
                <tr>
                    <td valign="top">State: </td>
                    <td><div id="div_state">undefined</div></td>
                </tr>
                <tr>
                    <td valign="top">Context:</td>
                    <td>
                        <a href="javascript:unhide('div_context');">Show/Hide</a>
                        <div id="div_context" class="hidden">
                            <div class="margin-bottom-big margin-top-small">
                                <button id="btn_addcontext" type="button" onclick="javascript:addContext('name', 'value')" title="Contextvariable hinzufügen">
                                    <img class='small' src='static/Images/list-add.png' width='16' height='16' alt="Contextvariable hinzufügen" title="Contextvariable hinzufügen"/>
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td valign="top">Endpoints:</td>
                    <td>
                        <a href="javascript:unhide('div_endpoints');">Show/Hide</a>
                        <div id="div_endpoints" class="hidden">
                            <div class="margin-bottom-big margin-top-small">
                                <button id="btn_addendpoint" type="button" onclick="javascript:addEndpoint('name', 'url')" title="Endpoint hinzufügen">
                                    <img class='small' src='static/Images/list-add.png' width='16' height='16' alt="Endpoint hinzufügen" title="Endpoint hinzufügen"/>
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td valign="top">Description:</td>
                    <td>
                        <a href="javascript:unhide('div_description');">Show/Hide</a>
                        <div id="div_description" class="hidden">
                            <textarea id ="txt_description" cols="60" rows="10"></textarea>
                        </div>
                    </td>
                </tr>
            </table>
            <button id="btn_apply" type="button" onclick="javascript:apply()">Apply to current instance</button>
    </form>
    <h5>WorkflowExecutionEngine - Workflow Information CocKpit</h5>
    <p>activity :a1, :call, hotel, @x, @y</p>
  </body>




  <div class="invisible" id="add_context">
    <div>
        <button type="button" onclick="$(this).parent().remove()" title="Contextvariable entfernen">
            <img class='small' src='static/Images/list-remove.png' width='16' height='16' alt="Contextvariable entfernen" title="Contextvariable entfernen"/>
        </button>
        <input value="name" type="text" id="context_variable_name"/>
        <input value="value" type="text" id="context_variable_value" />
    </div>
  </div>
  <div class="invisible" id="add_endpoint">
    <div>
        <button type="button" onclick="$(this).parent().remove()" title="Endpoint entfernen">
            <img class='small' src='static/Images/list-remove.png' width='16' height='16' alt="Endpoint entfernen" title="Endpoint entfernen"/>
        </button>
        <input value="name" type="text" id="endpoint_name"/>
        <input value="url" type="text" id="endpoint_value"/>
    </div>
  </div>


<script type='text/javascript'>

    var wee_url = "";
    var demo = true;

    function makeRequest(method, url, success, failure) {
        var req = new XMLHttpRequest();  
        req.open(method, url, true);  
        req.onreadystatechange = function (e) {  
            if (req.readyState === 4) {  
                if(req.status === 200) {
                    success(req.responseText);
                } else {  
                    failure("method "+method+" to "+url+" failed");
                }
                method
            }  
        };  
        req.send(null);
    }
    function report_failure(text) {
        console.log("ERROR: "+text);
    }

    function loadInstance() {
        console.log("Loading instance data");
        makeRequest(
            "GET", (wee_url+location.pathname+"/state/"),
            function(instance_state){
                console.log("got instance state = "+instance_state);
                $("#div_state").text(instance_state);
            },report_failure
        );
        // Getting the workflow description
        makeRequest(
            "GET", (wee_url+location.pathname+"/properties/description/"),
            function(instance_description){
                console.log("got instance_description = "+instance_description);
                $("#txt_description").val(instance_description);
            },report_failure
        );
        // Getting the Context
        makeRequest(
            "GET", (wee_url+location.pathname+"/properties/context/"),
            function(xml){
                $(xml).find("a").each(function() {
                  var a = $(this);
                  var context_id = a.text();
                  console.log("found context id "+context_id);
                  makeRequest(
                    "GET", (wee_url+location.pathname+"/properties/context/"+context_id),
                    function(context_value){
                      console.log("found context value. id="+context_id+", value="+context_value);
                      addContext(context_id, context_value);
                    },report_failure
                  );
                })
            }, report_failure
        );

        // Getting the Endpoints
        makeRequest(
            "GET", (wee_url+location.pathname+"/properties/endpoints/"),
            function(xml){
                $(xml).find("a").each(function() {
                  var a = $(this);
                  var endpoint_id = a.text();
                  console.log("found endpoint "+endpoint_id);
                  makeRequest(
                    "GET", (wee_url+location.pathname+"/properties/endpoints/"+endpoint_id),
                    function(endpoint_value){
                      console.log("found endpoint value. id="+endpoint_id+", value="+endpoint_value);
                      addEndpoint(endpoint_id, endpoint_value);
                    },report_failure
                  );
                })
            }, report_failure
        );
    }
    function setDummyValues() {
        console.log("setting dummy values");
        addContext("x", "1");
        addContext("y", "2");
        addEndpoint("hotel", "http://server.com");
        $("#txt_description").val("activity :a1, :call, hotel, @x, @y");
    }

    function setContextVariable_serverside(context_id, context_value) {
        makeRequest(
            "POST", (wee_url+location.pathname+"/properties/context?id="+context_id+"&value="+context_value),
            function(){
                console.log("added context variable: id="+context_id+", value="+context_value);
            },report_failure
        );
    }
    function setEndpoint_serverside(endpoint_id, endpoint_value) {
        makeRequest(
            "POST", (wee_url+location.pathname+"/properties/endpoints?id="+endpoint_id+"&value="+endpoint_value),
            function(){
                console.log("added endpoint: id="+endpoint_id+", value="+endpoint_value);
            },report_failure
        );
    }
    function setDescription_serverside(description) {
        makeRequest(
            "PUT", (wee_url+location.pathname+"/properties/description?description="+encodeURIComponent(description)),
            function(){
                console.log("description setted to: "+description);
            },report_failure
        );
    }



    function unhide(divID) {
      var item = document.getElementById(divID);
      if (item) {
        item.className=(item.className=='hidden')?'unhidden':'hidden';
      }
    }

    var context_i = 0;
    function clearContext() {
        $("#div_context").html("");
    }
    function addContext(name, value) {
        console.log("Adding new context, name="+name+", value="+value);
        var text = $("#add_context").html();
        text = text.replace(/context_variable_name/,"context_variable_name_" + context_i);
        text = text.replace(/context_variable_value/,"context_variable_value_" + context_i);
        text = text.replace(/value=\"name\"/, "value=\""+name+"\"");
        text = text.replace(/value=\"value\"/, "value=\""+value+"\"");
        $("#div_context").append(text);
        context_i += 1;
    }

    var endpoint_i = 0;
    function clearEndpoints() {
        $("#div_endpoints").html("");
    }
    function addEndpoint(name, url) {
        console.log("Adding new endpoint, name="+name+", url="+url);
        var text = $("#add_endpoint").html();
        text = text.replace(/endpoint_name/,"endpoint_name_" + endpoint_i);
        text = text.replace(/endpoint_value/,"endpoint_value_" + endpoint_i);
        text = text.replace(/value=\"name\"/, "value=\""+name+"\"");
        text = text.replace(/value=\"url\"/, "value=\""+url+"\"");
        $("#div_endpoints").append(text);
        endpoint_i += 1;
    }
    
    function apply() {
        // apply context
        for(var i = 0; i < context_i; i++) {
            name = $("#context_variable_name_"+i).val();
            value = $("#context_variable_value_"+i).val();
            setContextVariable_serverside(name, value);
        }
        // apply endpoints
        for(var i = 0; i < endpoint_i; i++) {
            name = $("#endpoint_name_"+i).val();
            value = $("#endpoint_value_"+i).val();
            setEndpoint_serverside(name, value);
        }

        // apply description
        desc = $("#txt_description").val();
        setDescription_serverside(desc);
    }

    var running = false;
    function setPolling() {
        if(running) {
//            loadInstance();
//            setTimeout(setPolling, 5);
        }
    }
    function togglestartstop() {
        if(!running) {
            // deactivate controls
            // start the wee
            console.log("Starting the wee")
            makeRequest(
                "PUT", (wee_url+location.pathname+"/state?control=start"),
                function(instance_state){
                    console.log("got instance state = "+instance_state);
                    $("#div_state").text(instance_state);
                },report_failure
            );
            // update start/stop button
            $("#btn_startstop").val("Stop");
            running = true;
            // refresh ui constantly
            setPolling();
        }
        else {
            // stop the wee
            console.log("Stop the wee")
            makeRequest(
                "PUT", (wee_url+location.pathname+"/state?control=stop"),
                function(instance_state){
                    console.log("got instance state = "+instance_state);
                    $("#div_state").text(instance_state);
                },report_failure
            );
            // update start/stop button
            $("#btn_startstop").val("Start");
            running = false;
        }

    }

    console.log("Fetching wee url");
    $.ajax({
      type: "GET",
      url: "remote",
      cache: false,
      success: function(url){
        wee_url = url;
        console.log("got wee url: "+wee_url+". my path is "+location.pathname);
        loadInstance();
        console.log("checking for dummy values");
        if(demo) {
            console.log("ok, adding dummy values");
            setDummyValues();
        }
      }
    });

</script>

</html>
